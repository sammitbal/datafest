---
title: "datafest"
author: "Sammit Bal"
date: "2025-04-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## FrontMatter

```{r}
library(esquisse)
library(tidyverse)

maj_market_occu <- read.csv("./Major Market Occupancy Data-revised.csv")
price_avail <- read.csv("./Price and Availability Data.csv")
unem <- read.csv("./Unemployment.csv")
lease <- read.csv("./Leases.csv")

three_mc <- c("Los Angeles", "Manhattan", "Houston")
lease_3c <- lease %>% 
  filter(market == three_mc) %>%
  filter(!is.na(space_type))
```

## Understanding the Data

```{r}
colnames(maj_market_occu)
colnames(price_avail)
colnames(unem)
colnames(lease)
```

```{r}
# esquisser(data = unem, viewer = "browser")
# esquisser(unem)
```

## Consolidate Industry

```{r}

sum_industry <- lease %>%
  filter(market == c("Manhattan", "Los Angeles", "Houston") & is.na(internal_industry) == 0) %>%
  group_by(market, internal_industry) %>%
  summarize(count = n()) %>%
  mutate(prp = count/(sum(count))) %>%
  ungroup()


```


Make Rent, Occupancy, and Availability  graphs for Manhattan, LA, Houston


```{r}
# Combine rent data for all 3 cities
combined_rent_data <- lease %>%
  filter(market %in% c("Manhattan", "Los Angeles", "Houston")) %>%
  mutate(time = paste(year, ".", quarter, sep = "")) %>%
  group_by(market, time) %>%
  summarize(avg_rent = mean(overall_rent, na.rm = TRUE)) %>%
  arrange(market, time)

# Convert 'time' to ordered factor
combined_rent_data$time <- factor(combined_rent_data$time, levels = unique(combined_rent_data$time), ordered = TRUE)

############################# Rent #########################################
combined_rent_plot <- ggplot(combined_rent_data, aes(x = time, y = avg_rent, color = market, group = market)) +
  geom_line(size = 1.2) +
  geom_point() +
  geom_vline(xintercept = which(levels(combined_rent_data$time) == "2020.Q1"), 
             linetype = "dashed", color = "gray40", size = 1) +
  annotate("text", x = which(levels(combined_rent_data$time) == "2020.Q1"), y = Inf, 
           label = "COVID                               ", vjust = -0.5, angle = 90, size = 3, color = "gray40") +
  labs(
    title = "Overall Rent Trends (2018–2024)",
    subtitle = "Comparison across Manhattan, Los Angeles, and Houston",
    x = "Quarter",
    y = "Average Rent (USD per sq ft/year)",
    color = "Market"
  ) +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(combined_rent_plot)

############################## Availability ################################
combined_avail_data <- lease %>%
  filter(market %in% c("Manhattan", "Los Angeles", "Houston")) %>%
  mutate(time = paste(year, ".", quarter, sep = "")) %>%
  group_by(market, time) %>%
  summarize(availability_proportion = first(availability_proportion)) %>%
  arrange(market, time)

combined_avail_data$time <- factor(combined_avail_data$time, levels = unique(combined_avail_data$time), ordered = TRUE)

combined_avail_plot <- ggplot(combined_avail_data, aes(x = time, y = availability_proportion * 100, color = market, group = market)) +
  geom_line(size = 1.2) +
  geom_point() +
  geom_vline(xintercept = which(levels(combined_avail_data$time) == "2020.Q1"),
             linetype = "dashed", color = "gray40", size = 1) +
  annotate("text", x = which(levels(combined_avail_data$time) == "2020.Q1"), y = Inf,
           label = "COVID                               ", vjust = -0.5, angle = 90, size = 3, color = "gray40") +
  labs(
    title = "Availability Proportion Trends (2018–2024)",
    subtitle = "Comparison across Manhattan, Los Angeles, and Houston",
    x = "Quarter",
    y = "Availability (%)",
    color = "Market"
  ) +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(combined_avail_plot)

############################## Occupancy ####################################
combined_occupancy_data <- market_occupancy %>%
  filter(market %in% c("Manhattan", "Los Angeles", "Houston")) %>%
  mutate(time = paste(year, ".", quarter, sep = "")) %>%
  arrange(market, year, quarter)

combined_occupancy_data$time <- factor(combined_occupancy_data$time, levels = unique(combined_occupancy_data$time), ordered = TRUE)

combined_occupancy_plot <- ggplot(combined_occupancy_data, aes(x = time, y = avg_occupancy_proportion * 100, color = market, group = market)) +
  geom_line(size = 1.2) +
  geom_point() +
  labs(
    title = "Occupancy Proportion Trends (2020.Q1–2024.Q3)",
    subtitle = "Comparison across Manhattan, Los Angeles, and Houston",
    x = "Quarter",
    y = "Occupancy (%)",
    color = "Market"
  ) +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(combined_occupancy_plot)

#ggsave("Plots/combined_rent_trend.png", plot = combined_rent_plot, width = 8, height = 5, dpi = 300)
#ggsave("Plots/combined_availability_trend.png", plot = combined_avail_plot, width = 8, height = 5, dpi = 300)
#ggsave("Plots/combined_occupancy_trend.png", plot = combined_occupancy_plot, width = 8, height = 5, dpi = 300)


```



Histogram for each city for sublet available space.






```{r}
lease %>%
group_by(market) %>%
summarise(nmarket = n()) %>%
arrange(desc(nmarket))

```


```{r}
ggplot(data = lease_3c,
       mapping = aes(
         x = market,
         y = available_space)) +
  geom_boxplot() + 
  facet_grid(space_type ~ .)
```

